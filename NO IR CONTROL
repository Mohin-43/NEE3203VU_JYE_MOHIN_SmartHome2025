#include <Adafruit_NeoPixel.h>
#include <SPI.h>
#include <Wire.h>
#include "epd1in54_V2.h"
#include "imagedata.h"
#include "epdpaint.h"
#include <stdio.h>
#include <Adafruit_Sensor.h>
#include "Adafruit_BME680.h"
#include "SparkFun_VEML6030_Ambient_Light_Sensor.h"
#include "DFRobot_INA219.h"
#include <SparkFun_MAX1704x_Fuel_Gauge_Arduino_Library.h>
#include <math.h> 

// ========================================
// Pin Definitions
// ========================================
#define PWM_PIN 6             // Fan control
#define TACH_PIN 4            // Fan tachometer
#define POT_PIN A0            // Potentiometer
#define DISTANCE_PIN A4       // Distance sensor (3-pin analog)
#define GLOW_BIT_PIN 5        // NeoPixel Glow Bit Light 1x8
#define AL_ADDR 0x48          // Ambient light sensor I2C address
#define POT_MAX_OHMS 50000.0

// ========================================
// NeoPixel Glow Bit Setup (1x8)
// ========================================
#define LED_COUNT 8
Adafruit_NeoPixel glowBit(LED_COUNT, GLOW_BIT_PIN, NEO_GRB + NEO_KHZ800);

// Smart LED Thresholds
#define PRESENCE_DISTANCE 50  // This constant is no longer strictly used, logic is hardcoded in updateSmartLEDs()

// ========================================
// E-paper Setup
// ========================================
Epd epd;
unsigned char image[1024], blankBase[5000]; 
Paint paint(image, 0, 0);                   
#define COLORED 0
#define UNCOLORED 1

// ========================================
// Sensor Objects
// ========================================
SparkFun_Ambient_Light light(AL_ADDR);
Adafruit_BME680 bme(&Wire1);
DFRobot_INA219_IIC ina219(&Wire1, INA219_I2C_ADDRESS4);
SFE_MAX1704X fuelGauge(MAX1704X_MAX17048);

// ========================================
// Sensor Data Variables
// ========================================
float gain = .25, temperature = 0, humidity = 0, pressure = 0, gasResistance = 0;
float batteryVoltage = 0, batterySOC = 0, batteryChangeRate = 0;
float busVoltage = 0, shuntVoltage = 0, current_mA = 0, power_mW = 0, totalEnergy_mWh = 0;
long luxVal = 0;
long distance = 0;
int Integtime = 700, potValue = 0, fanSpeed = 0, blinkInterval = 500, updateCount = 0;
float potOhms = 0;
bool ina219Ready = false, fuelGaugeReady = false, lightReady = false, ledState = false;

// ========================================
// Timing Variables
// ========================================
unsigned long lastSensorRead = 0, lastEnergyUpdate = 0, lastFanUpdate = 0, lastLEDToggle = 0;
unsigned long lastSmartLEDUpdate = 0, lastEPaperUpdate = 0;

const unsigned long sensorReadInterval = 500; // Medium: BME680, INA, VEML, MAX (500ms)
const unsigned long ePaperInterval = 3000;    // Slow: E-paper partial refresh (3000ms)
const unsigned long fanUpdateInterval = 100;
const unsigned long smartLEDInterval = 100;   // Fast: Distance sensor check (100ms)
const unsigned long fullRefreshCycle = 20;    // Number of partial updates before a full refresh

// ========================================
// Forward Declarations
// ========================================
void scanI2C();
void readFanControl();
void readSensors();
long readDistance();
void updateSmartLEDs();
void displayLine(int &yPos, const char* text, bool partial = false);
void displayFullScreen();
void updateDisplayPartial();
void printSensorData();

// ========================================
// Utility Functions
// ========================================
void scanI2C() {
  int nDevices = 0;
  Serial.println("Scanning I2C bus (Wire1 - QWIIC)...");
  for(byte address = 1; address < 127; address++) {
    Wire1.beginTransmission(address);
    if (Wire1.endTransmission() == 0) {
      Serial.print("  Device found at 0x");
      if (address < 16) Serial.print("0");
      Serial.println(address, HEX);
      nDevices++;
    }
  }
  if (nDevices == 0) {
    Serial.println("  No I2C devices found!\n");
  } else {
    Serial.print("  "); Serial.print(nDevices); Serial.println(" device(s) found.\n");
  }
}

// ========================================
// Smart LED Control Functions (DISTANCE ONLY)
// ========================================

// Function to read distance from 3-pin sensor on A4
long readDistance() {
  int raw = analogRead(DISTANCE_PIN);
  if (raw < 10) return -1; // too low = out of range
  float voltage = raw * (5.0 / 1023.0);
  // empirical formula for GP2Y0A21YK0F
  long distance = 27.86 * pow(voltage, -1.15); 
  // Clamp to a sensible maximum for logging
  if (distance > 100) distance = 100;
  return distance;
}

// Main Smart LED update function (Distance Sensor ONLY)
void updateSmartLEDs() {
  // Read distance sensor
  distance = readDistance();
  
  glowBit.clear(); // Start clean
  // Define the color to be used when LEDs are ON (Bright Yellow/White)
  uint32_t color = glowBit.Color(255, 200, 50); 
  
  // LOGIC: Control LEDs based ONLY on distance thresholds
  
  if (distance >= 14 && distance <= 20) {
    // 14cm <= Distance <= 20cm: First and last 2 LEDs ON (0, 1, 6, 7)
    Serial.print("Status: Distance 14-20cm (Partial Presence)");
    Serial.print(" Dist: "); Serial.print(distance); Serial.println("cm");
    Serial.println("Action: First/Last 2 LEDs ON");
    
    glowBit.setPixelColor(0, color); 
    glowBit.setPixelColor(1, color); 
    glowBit.setPixelColor(6, color); 
    glowBit.setPixelColor(7, color); 
    
  } else if (distance >= 10 && distance < 14) {
    // 10cm <= Distance < 14cm: All 8 LEDs ON (Full Presence)
    Serial.print("Status: Distance 10-14cm (Full Presence)");
    Serial.print(" Dist: "); Serial.print(distance); Serial.println("cm");
    Serial.println("Action: All 8 LEDs ON");
    
    for (int i = 0; i < LED_COUNT; i++) {
      glowBit.setPixelColor(i, color); 
    }
    
  } else if (distance < 10 && distance >= 0) {
    // Distance < 10cm: LEDs OFF
    Serial.print("Status: Distance < 10cm (Too Close/Obstruction)");
    Serial.print(" Dist: "); Serial.print(distance); Serial.println("cm");
    Serial.println("Action: All LEDs OFF");
    // Already clear
    
  } else { // Covers distance > 20cm or error states (distance < 0)
    // Distance > 20cm: LEDs OFF
    Serial.print("Status: Distance > 20cm (No Presence)");
    Serial.print(" Dist: "); Serial.print(distance); Serial.println("cm");
    Serial.println("Action: All LEDs OFF");
    // Already clear
  }
  
  glowBit.show();
}

// ========================================
// Sensor Reading Functions
// ========================================

void readFanControl() {
  potValue = analogRead(POT_PIN);
  potOhms = (potValue / 1023.0) * POT_MAX_OHMS;
  fanSpeed = map(potValue, 0, 1023, 0, 255);
  blinkInterval = constrain(map(fanSpeed, 0, 255, 1000, 50), 50, 1000);
}

void readSensors() {
  // Read ambient light sensor (VEML6030) - Data still collected for display/logging
  if (lightReady) {
    luxVal = light.readLight(); 
  } else {
    // If sensor failed, set to 0 for clear logging/display
    luxVal = 0; 
  }
  
  // Read environmental sensor (BME680)
  if (bme.performReading()) {
    temperature = bme.temperature;
    humidity = bme.humidity;
    pressure = bme.pressure / 100.0;
    gasResistance = bme.gas_resistance / 1000.0;
  }
  
  // Read battery fuel gauge
  if (fuelGaugeReady) {
    batteryVoltage = fuelGauge.getVoltage();
    batterySOC = fuelGauge.getSOC();
    batteryChangeRate = fuelGauge.getChangeRate();
    if (fuelGauge.getAlert()) {
      Serial.println("⚠️  WARNING: Battery critically low!");
    }
  }
  
  // Read power monitor
  if (ina219Ready) {
    busVoltage = ina219.getBusVoltage_V();
    shuntVoltage = ina219.getShuntVoltage_mV();
    current_mA = ina219.getCurrent_mA();
    power_mW = ina219.getPower_mW();
    if (busVoltage < 0 || busVoltage > 32) busVoltage = 0;
  }
}

// ========================================
// Display Functions
// ========================================

void displayLine(int &yPos, const char* text, bool partial) {
  // Set width/height for single data line draw
  paint.SetWidth(200);
  paint.SetHeight(16); 
  paint.Clear(UNCOLORED); 
  paint.DrawStringAt(5, 0, text, &Font12, COLORED);
  
  if (partial) {
    epd.SetFrameMemoryPartial(paint.GetImage(), 0, yPos, paint.GetWidth(), paint.GetHeight());
  } else {
    epd.SetFrameMemory(paint.GetImage(), 0, yPos, paint.GetWidth(), paint.GetHeight());
  }
  yPos += 16; 
}

void displayFullScreen() {
  char buf[30];
  int yPos = 0;
  
  // --- Title Bar (200x20) ---
  paint.SetWidth(200);
  paint.SetHeight(20); 
  paint.Clear(COLORED); // Draw black background
  paint.DrawStringAt(5, 2, "Smart LED Monitor", &Font12, UNCOLORED); // White text
  epd.SetFrameMemory(paint.GetImage(), 0, yPos, paint.GetWidth(), paint.GetHeight());
  yPos = 22; // Start after Title bar (20px high + 2px gap)
  
  // Environment Section (5 lines)
  sprintf(buf, "Temp: %.1fC", temperature); displayLine(yPos, buf); 
  sprintf(buf, "Humid: %.1f%%", humidity); displayLine(yPos, buf); 
  sprintf(buf, "Press: %.0fhPa", pressure); displayLine(yPos, buf); 
  sprintf(buf, "Light: %ldLux", luxVal); displayLine(yPos, buf); 
  sprintf(buf, "Dist: %ldcm", distance); displayLine(yPos, buf); 
  
  // Fan Section
  yPos += 2; // Spacer 
  sprintf(buf, "--- Fan ---"); displayLine(yPos, buf); 
  sprintf(buf, "Speed: %d%%", map(fanSpeed, 0, 255, 0, 100)); displayLine(yPos, buf); 
  sprintf(buf, potOhms >= 1000 ? "Pot: %.1fkOhm" : "Pot: %.0fOhm", 
          potOhms >= 1000 ? potOhms/1000.0 : potOhms); 
  displayLine(yPos, buf); 
  
  // Power Section
  yPos += 2; // Spacer 
  sprintf(buf, "--- Power ---"); displayLine(yPos, buf); 
  
  if (fuelGaugeReady) {
    sprintf(buf, "Batt: %.1f%%", batterySOC); displayLine(yPos, buf); 
    sprintf(buf, "BatV: %.2fV", batteryVoltage); displayLine(yPos, buf); 
  }
  if (ina219Ready) {
    sprintf(buf, "Curr: %.1fmA", current_mA); displayLine(yPos, buf); 
    sprintf(buf, "Powr: %.1fmW", power_mW); displayLine(yPos, buf); 
  }
  
  epd.DisplayFrame();
  Serial.println("Full frame displayed");
}

void updateDisplayPartial() {
  char buf[30];
  int yPos = 22; // Start after Title bar
  
  paint.SetWidth(200);
  paint.SetHeight(16);
  
  // Environment Data (yPos 22, 38, 54, 70, 86)
  sprintf(buf, "Temp: %.1fC", temperature); displayLine(yPos, buf, true);
  sprintf(buf, "Humid: %.1f%%", humidity); displayLine(yPos, buf, true);
  sprintf(buf, "Press: %.0fhPa", pressure); displayLine(yPos, buf, true);
  sprintf(buf, "Light: %ldLux", luxVal); displayLine(yPos, buf, true);
  sprintf(buf, "Dist: %ldcm", distance); displayLine(yPos, buf, true);
  
  // Fan Data (Starts at yPos 120, data at 136)
  yPos = 136; // Position of the 'Speed' line
  sprintf(buf, "Speed: %d%%", map(fanSpeed, 0, 255, 0, 100)); displayLine(yPos, buf, true); 
  sprintf(buf, potOhms >= 1000 ? "Pot: %.1fkOhm" : "Pot: %.0fOhm", 
          potOhms >= 1000 ? potOhms/1000.0 : potOhms);
  displayLine(yPos, buf, true); 
  
  // Power Data (Starts at yPos 170, data at 186)
  yPos = 186; // Position of the 'Batt' line
  
  if (fuelGaugeReady) {
    sprintf(buf, "Batt: %.1f%%", batterySOC); displayLine(yPos, buf, true); 
    sprintf(buf, "BatV: %.2fV", batteryVoltage); displayLine(yPos, buf, true); 
  }
  if (ina219Ready) {
    sprintf(buf, "Curr: %.1fmA", current_mA); displayLine(yPos, buf, true); 
    sprintf(buf, "Powr: %.1fmW", power_mW); displayLine(yPos, buf, true); 
  }
  
  epd.DisplayPartFrame();
}

void printSensorData() {
  Serial.println("========================================");
  Serial.println("=== Environmental Sensors ===");
  Serial.print("Temperature: "); Serial.print(temperature); Serial.println(" °C");
  Serial.print("Humidity: "); Serial.print(humidity); Serial.println(" %");
  Serial.print("Pressure: "); Serial.print(pressure); Serial.println(" hPa");
  Serial.print("Gas Resistance: "); Serial.print(gasResistance); Serial.println(" KOhms");
  Serial.print("Ambient Light: "); Serial.print(luxVal); Serial.println(" Lux");
  Serial.print("Distance: "); Serial.print(distance); Serial.println(" cm");
  
  Serial.println("\n=== Fan Control ===");
  Serial.print("Potentiometer: "); Serial.print(potOhms); Serial.println(" Ohms");
  Serial.print("Fan Speed: "); Serial.print(map(fanSpeed, 0, 255, 0, 100)); 
  Serial.print("% (PWM: "); Serial.print(fanSpeed); Serial.println(")");
  
  Serial.println("\n=== Power Monitoring ===");
  if (fuelGaugeReady) {
    Serial.print("Battery Voltage: "); Serial.print(batteryVoltage); Serial.println(" V");
    Serial.print("Battery SOC: "); Serial.print(batterySOC); Serial.println(" %");
    Serial.print("Battery Change Rate: "); Serial.print(batteryChangeRate); Serial.println(" %/hr");
  }
  if (ina219Ready) {
    Serial.print("Bus Voltage: "); Serial.print(busVoltage); Serial.println(" V");
    Serial.print("Current Draw: "); Serial.print(current_mA); Serial.println(" mA");
    Serial.print("Power Consumption: "); Serial.print(power_mW); Serial.println(" mW");
    Serial.print("Total Energy Used: ");
    if (totalEnergy_mWh < 1000) {
      Serial.print(totalEnergy_mWh); Serial.println(" mWh");
    } else {
      Serial.print(totalEnergy_mWh / 1000.0); Serial.println(" Wh");
    }
  }
  Serial.println("========================================\n");
}

// ========================================
// Setup Function
// ========================================
void setup() {
  Serial.begin(115200);
  while(!Serial && millis() < 3000) delay(10);
  
  Serial.println("========================================");
  Serial.println("Integrated Smart LED & Sensor Monitor");
  Serial.println("========================================");
  
  // Pin setup
  pinMode(PWM_PIN, OUTPUT);
  pinMode(TACH_PIN, INPUT_PULLUP);
  pinMode(LED_BUILTIN, OUTPUT);
  pinMode(POT_PIN, INPUT);
  pinMode(GLOW_BIT_PIN, OUTPUT);
  
  // Initialize NeoPixel Glow Bit (1x8)
  glowBit.begin(); 
  glowBit.show();
  // Set brightness to half (100 out of 255 max)
  glowBit.setBrightness(100); 
  
  // Initialize I2C
  Wire1.begin();
  delay(500);
  scanI2C();
  
  // Initialize VEML6030 Light Sensor (still initialized for logging/display)
  if(light.begin(Wire1)) {
    lightReady = true; 
    light.setGain(gain);
    light.setIntegTime(Integtime);
    Serial.println("✓ VEML6030 Light Sensor ready!"); 
  } else {
    Serial.println("✗ VEML6030 failed! Data collected only from distance sensor.");
  }
  
  // Initialize BME680 Environmental Sensor
  if (bme.begin()) {
    bme.setTemperatureOversampling(BME680_OS_8X);
    bme.setHumidityOversampling(BME680_OS_2X);
    bme.setPressureOversampling(BME680_OS_4X);
    bme.setIIRFilterSize(BME680_FILTER_SIZE_3);
    bme.setGasHeater(320, 150);
    Serial.println("✓ BME680 Environmental Sensor ready!");
  } else {
    Serial.println("✗ BME680 failed!");
  }
  
  // Initialize INA219 Power Monitor
  int retryCount = 0;
  while(ina219.begin() != true && retryCount < 5) {
    delay(1000);
    retryCount++;
  }
  if(retryCount < 5) {
    ina219.linearCalibrate(1000, 1000);
    ina219Ready = true;
    Serial.println("✓ INA219 Power Monitor ready!");
  } else {
    Serial.println("✗ INA219 init failed after 5 attempts.");
  }
  
  // Initialize MAX17048 Battery Fuel Gauge
  if (fuelGauge.begin(Wire1)) {
    fuelGaugeReady = true;
    fuelGauge.quickStart();
    delay(200);
    fuelGauge.setThreshold(10);
    Serial.println("✓ MAX17048 Battery Monitor ready!");
  } else {
    Serial.println("✗ MAX17048 failed!");
  }
  
  // E-paper setup 
  Serial.println("\nInitializing e-Paper display...");
  epd.LDirInit(); 
  epd.Clear();
  
  // Initial sensor reads before full display refresh
  readSensors();
  readFanControl();
  
  // Full refresh on startup with static headers and initial data
  displayFullScreen();
  delay(2000);
  
  // Initialize for partial refresh
  epd.HDirInit(); 
  memset(blankBase, 0xFF, sizeof(blankBase));
  epd.DisplayPartBaseImage(blankBase); 
  
  lastEnergyUpdate = lastFanUpdate = lastLEDToggle = lastSmartLEDUpdate = lastEPaperUpdate = millis();
  
  Serial.println("\n========================================");
  Serial.println("System Ready!");
  Serial.println("========================================\n");
}

// ========================================
// Main Loop
// ========================================
void loop() {
  unsigned long currentMillis = millis();
  
  // 1. Fast Fan Control Update (100ms)
  if (currentMillis - lastFanUpdate >= fanUpdateInterval) {
    lastFanUpdate = currentMillis;
    readFanControl();
    analogWrite(PWM_PIN, fanSpeed);
    
    // LED blink based on fan speed (keep tied to fan update for visual effect)
    if (currentMillis - lastLEDToggle >= blinkInterval) {
      lastLEDToggle = currentMillis;
      digitalWrite(LED_BUILTIN, ledState = !ledState);
    }
  }
  
  // 2. Smart LED control update (Distance Sensor check) (100ms)
  // This is the most critical update for responsiveness
  if (currentMillis - lastSmartLEDUpdate >= smartLEDInterval) {
    lastSmartLEDUpdate = currentMillis;
    updateSmartLEDs(); 
  }

  // 3. Medium Sensor Read Update (500ms)
  // This reads BME680, VEML6030, INA219, MAX17048
  if (currentMillis - lastSensorRead >= sensorReadInterval) {
    lastSensorRead = currentMillis;
    
    // Read all sensors (environmental and power)
    readSensors();
    
    if (ina219Ready) {
      // Calculate energy consumption since the last sensor read
      totalEnergy_mWh += (power_mW * (currentMillis - lastEnergyUpdate) / 3600000.0);
    }
    // Update the last energy time, regardless of whether INA was ready, for next calculation
    lastEnergyUpdate = currentMillis; 
    
    // Log data periodically (tied to sensor read)
    printSensorData();
  }
  
  // 4. Slow E-paper Update (3000ms)
  if (currentMillis - lastEPaperUpdate >= ePaperInterval) {
    lastEPaperUpdate = currentMillis;
    updateCount++;
    
    // Check if it's time for a full refresh
    if (updateCount >= fullRefreshCycle) { 
      // Periodic full refresh
      Serial.println("Periodic full refresh...");
      epd.LDirInit(); 
      epd.Clear();
      displayFullScreen();
      delay(1000); // Delay for full refresh completion
      epd.HDirInit(); 
      memset(blankBase, 0xFF, sizeof(blankBase));
      epd.DisplayPartBaseImage(blankBase); 
      updateCount = 0;
    } else {
      updateDisplayPartial(); 
    }
  }
}
